<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>STARLET Auth Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(to right, #667eea, #764ba2);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    .glass {
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      border-radius: 1rem;
      backdrop-filter: blur(10px);
      width: 100%;
      max-width: 500px;
      padding: 2rem;
    }
  </style>
</head>
<body>

  <div class="glass">
    <div class="text-center mb-6">
      <h2 class="text-3xl font-bold text-indigo-700">STARLET BSc Bio Classes</h2>
      <p class="text-gray-600" id="formTitle">Login to your account</p>
    </div>

    <form id="authForm" class="space-y-4">
      <div id="extraFields" class="hidden space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Name</label>
          <input id="name" type="text" placeholder="Your Name" class="w-full px-4 py-2 rounded border" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Mobile</label>
          <input id="mobile" type="text" placeholder="1234567890" class="w-full px-4 py-2 rounded border" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Course</label>
          <select id="course" class="w-full px-4 py-2 rounded border">
            <option value="">Choose Course</option>
            <option value="BSc 1st Year">BSc 1st Year</option>
            <option value="BSc 2nd Year">BSc 2nd Year</option>
            <option value="BSc 3rd Year">BSc 3rd Year</option>
          </select>
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700">Email</label>
        <input id="email" type="email" class="w-full px-4 py-2 rounded border" required />
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700">Password</label>
        <input id="password" type="password" class="w-full px-4 py-2 rounded border" required />
      </div>

      <div class="flex justify-between text-sm">
        <a href="#" id="forgotPassword" class="text-indigo-600 hover:underline">Forgot Password?</a>
        <button type="button" id="toggleForm" class="text-indigo-600 hover:underline">Don't have an account? Sign Up</button>
      </div>

      <button type="submit" id="authBtn"
        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg font-semibold">
        <span id="authText">Login</span>
      </button>

      <button id="payNow" class="hidden w-full mt-2 bg-red-500 text-white py-2 rounded-lg font-semibold" onclick="window.location.href='GPay.html'; return false;">Pay Now</button>
    </form>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import {
      getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword,
      sendPasswordResetEmail, signOut
    } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
    import {
      getFirestore, setDoc, doc, getDoc
    } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCOKKBSbZJk8QSGvj1CPYQb_kjQb1tXO6s",
      authDomain: "starlet-registor.firebaseapp.com",
      databaseURL: "https://starlet-registor-default-rtdb.firebaseio.com",
      projectId: "starlet-registor",
      storageBucket: "starlet-registor.appspot.com",
      messagingSenderId: "904193225045",
      appId: "1:904193225045:web:0c9ed3f3d7251862ff7fdc",
      measurementId: "G-1NLM1F0262"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let isLogin = true;
    const toggleBtn = document.getElementById("toggleForm");
    const formTitle = document.getElementById("formTitle");
    const authText = document.getElementById("authText");
    const extraFields = document.getElementById("extraFields");
    const payNowBtn = document.getElementById("payNow");

    toggleBtn.addEventListener("click", () => {
      isLogin = !isLogin;
      formTitle.textContent = isLogin ? "Login to your account" : "Create a new account";
      authText.textContent = isLogin ? "Login" : "Sign Up";
      toggleBtn.textContent = isLogin ? "Don't have an account? Sign Up" : "Already have an account? Login";
      extraFields.classList.toggle("hidden", isLogin);
      payNowBtn.classList.add("hidden");
    });

    document.getElementById("authForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;
      const name = document.getElementById("name")?.value;
      const mobile = document.getElementById("mobile")?.value;
      const course = document.getElementById("course")?.value;

      authText.textContent = isLogin ? "Logging in..." : "Signing up...";
      authBtn.disabled = true;

      try {
        if (isLogin) {
          const userCredential = await signInWithEmailAndPassword(auth, email, password);
          if (!userCredential.user.emailVerified) {
            alert("Please verify your email first.");
            await signOut(auth);
            return;
          }

          const userDoc = await getDoc(doc(db, "users", userCredential.user.uid));
          if (userDoc.exists()) {
            const data = userDoc.data();
            if (data.hasAccess) {
              window.location.href = "dashboard.html";
            } else {
              payNowBtn.classList.remove("hidden");
              alert("Access denied. Please pay to access the dashboard.");
              await signOut(auth);
            }
          } else {
            alert("No user data found.");
            await signOut(auth);
          }
        } else {
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          const uid = userCredential.user.uid;
          await setDoc(doc(db, "users", uid), {
            name, mobile, course, email, hasAccess: false
          });
          userCredential.user.sendEmailVerification();
          alert("Signup successful! Please verify your email.");
          await signOut(auth);
        }
      } catch (error) {
        alert(error.message);
      } finally {
        authText.textContent = isLogin ? "Login" : "Sign Up";
        authBtn.disabled = false;
      }
    });

    document.getElementById("forgotPassword").addEventListener("click", async () => {
      const email = prompt("Enter your email:");
      if (email) {
        try {
          await sendPasswordResetEmail(auth, email);
          alert("Reset link sent.");
        } catch (err) {
          alert(err.message);
        }
      }
    });
  </script>
</body>
</html>
